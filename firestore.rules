rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper to check if a uid is one of the progenitores for a given hijoId
    function isProgenitor(uid, hijoId) {
      return exists(/databases/$(database)/documents/hijos/$(hijoId)) &&
        uid in get(/databases/$(database)/documents/hijos/$(hijoId)).data.progenitores;
    }

    // Mensajes: allow create only if the authenticated user is the declared sender
    // and is a progenitor of the referenced hijoId. Allow read only for progenitores.
    match /mensajes/{messageId} {
      allow create: if request.auth != null
        && request.resource.data.senderId == request.auth.uid
        && request.resource.data.hijoId is string
        && isProgenitor(request.auth.uid, request.resource.data.hijoId);

      allow read: if request.auth != null
        && resource.data.hijoId is string
        && isProgenitor(request.auth.uid, resource.data.hijoId);

      // Prevent clients from modifying or deleting existing messages via client SDK
      allow update, delete: if false;
    }

    // hijos: allow progenitores to read/write their own child entries via app flows.
    match /hijos/{hijoId} {
      allow read: if request.auth != null && (
        // allow read if auth is one of progenitores
        exists(/databases/$(database)/documents/hijos/$(hijoId)) &&
        request.auth.uid in get(/databases/$(database)/documents/hijos/$(hijoId)).data.progenitores
      );

      // Creation: allow authenticated users to create a hijo where they are added as progenitor
      allow create: if request.auth != null && request.resource.data.progenitores is list
        && request.auth.uid in request.resource.data.progenitores;

      // Updates: restrict to progenitores
      allow update, delete: if request.auth != null
        && exists(/databases/$(database)/documents/hijos/$(hijoId))
        && request.auth.uid in get(/databases/$(database)/documents/hijos/$(hijoId)).data.progenitores;
    }

    // User tokens: a user may write/read/delete tokens under their own user document
    match /users/{uid}/fcmTokens/{tokenId} {
      allow create, update: if request.auth != null && request.auth.uid == uid;
      allow delete: if request.auth != null && request.auth.uid == uid;
      allow read: if request.auth != null && request.auth.uid == uid;
    }

    // Basic user doc access: users can read and write their own profile (minimal)
    match /users/{uid} {
      allow read, update, create: if request.auth != null && request.auth.uid == uid;
    }

    // Fallback: deny everything else
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
